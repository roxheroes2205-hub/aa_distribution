<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AA Chest Distribution Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
        }

        .config-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .url-inputs {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .url-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .url-input-group label {
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        .url-input-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        .url-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .load-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .load-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .load-button:active {
            transform: translateY(0);
        }

        .load-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            color: #555;
            font-weight: 600;
            font-size: 0.95em;
        }

        select, input[type="text"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            background: white;
            transition: border-color 0.3s;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #fff;
            font-size: 2em;
            font-weight: 700;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        th.sortable::after {
            content: ' â‡…';
            opacity: 0.5;
        }

        th.sorted-asc::after {
            content: ' â†‘';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' â†“';
            opacity: 1;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-eligible {
            background: #d4edda;
            color: #155724;
        }

        .badge-one-box {
            background: #fff3cd;
            color: #856404;
        }

        .badge-no-boxes {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-no-attempts {
            background: #e2e3e5;
            color: #383d41;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-container input {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 8px;
            }
        }

        .helper-text {
            color: #666;
            font-size: 0.85em;
            margin-top: 5px;
            font-style: italic;
        }

        .instructions {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #333;
        }

        .instructions h3 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .instructions code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ® AA Chest Distribution Manager</h1>
        <p class="subtitle">Automated reward distribution based on Abyssal Arcade performance</p>

        <div class="controls">
            <div class="control-group">
                <label for="wedRanking">Wednesday Ranking:</label>
                <select id="wedRanking">
                    <option value="240">Rank 1 (240 boxes)</option>
                    <option value="150">Rank 2 (150 boxes)</option>
                    <option value="120">Rank 3 (120 boxes)</option>
                    <option value="80">Rank 4-5 (80 boxes)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="friRanking">Friday Ranking:</label>
                <select id="friRanking">
                    <option value="240">Rank 1 (240 boxes)</option>
                    <option value="150">Rank 2 (150 boxes)</option>
                    <option value="120">Rank 3 (120 boxes)</option>
                    <option value="80">Rank 4-5 (80 boxes)</option>
                </select>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Members</div>
                <div class="stat-value" id="totalMembers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Wed Participants</div>
                <div class="stat-value" id="wedParticipants">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Fri Participants</div>
                <div class="stat-value" id="friParticipants">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Boxes (Wed)</div>
                <div class="stat-value" id="totalWedBoxes">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Boxes (Fri)</div>
                <div class="stat-value" id="totalFriBoxes">0</div>
            </div>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ðŸ” Search by member name...">
        </div>

        <div class="table-container">
            <table id="distributionTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="name">Member Name</th>
                        <th class="sortable" data-column="attempts">Attempts</th>
                        <th class="sortable" data-column="wedPoints">Wed Points</th>
                        <th class="sortable" data-column="wedBoxes">Wed Boxes</th>
                        <th class="sortable" data-column="wedStatus">Wed Status</th>
                        <th class="sortable" data-column="friPoints">Fri Points</th>
                        <th class="sortable" data-column="friBoxes">Fri Boxes</th>
                        <th class="sortable" data-column="friStatus">Fri Status</th>
                        <th class="sortable" data-column="totalBoxes">Total Boxes</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                            Load data from Google Sheets to begin
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let guildData = [];
        let wednesdayData = [];
        let fridayData = [];
        let distributionData = [];
        let currentSort = { column: 'attempts', ascending: false };

        // Name mapping for known discrepancies
        const nameMapping = {
            'SONICâœ—': 'SONIC âœ—',
            'Artemis': 'Artemis Î¶',
            'Artemis â˜¾': 'Artemis Î¶',
            'SnowMan': 'â€» SnowMan â€»',
            'Bâ‚â‚Câ‚–Bâ‚ƒâ‚ƒáµ£d': 'Bâ‚â‚Câ‚–Bâ‚ƒard',
            'Bâ‚â‚ˆCâ‚„Bâ‚ƒâ‚ƒrd': 'Bâ‚â‚Câ‚–Bâ‚ƒard',
            'Valkyrie': 'Valkkyrie',
            'Elysiaâœ¿': 'Elysia â€',
            '-Grimmjow-': '-GrimmjÃ³w-',
            'MILIM Â· NAVA': 'MILIMãƒ»NAVA',
            'ê€§Ragingê€¤': 'á¿¶Ragingá¿’',
            'BigMacCombao': 'BigMacCombo',
            'Cwees': 'BigMacCombo'
        };

        function normalizeMemberName(name) {
            return nameMapping[name] || name;
        }

        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch: ${response.statusText}`);
            }
            const text = await response.text();
            return parseCSV(text);
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index].trim();
                    });
                    data.push(row);
                }
            }

            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Hardcoded data source URLs - one for each sheet
        const SPREADSHEET_ID = '2PACX-1vTrBAabijSXXurqd_bp5i-_JhmzzMvwCNUNyIwQy6mBTAiNjfalcUsCqRMiC917lCbC7gAwjWDGhJbD';
        
        // GIDs for each sheet tab
        const GUILD_GID = '0';           // Guild Members (first tab)
        const WED_GID = '793464544';     // Wednesday AA (second tab)
        const FRI_GID = '227803825';     // Friday AA (third tab)
        
        const GUILD_URL = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?gid=${GUILD_GID}&single=true&output=csv`;
        const WED_URL = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?gid=${WED_GID}&single=true&output=csv`;
        const FRI_URL = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?gid=${FRI_GID}&single=true&output=csv`;

        async function loadData() {
            const statusMsg = document.getElementById('statusMessage');
            const loadBtn = document.getElementById('loadDataBtn');

            if (loadBtn) loadBtn.disabled = true;
            if (statusMsg) {
                statusMsg.className = 'status-message info';
                statusMsg.textContent = 'â³ Loading data from Google Sheets...';
            }

            try {
                // Load all three datasets from different sheets
                const [guild, wedData, friData] = await Promise.all([
                    fetchCSV(GUILD_URL),
                    fetchCSV(WED_URL),
                    fetchCSV(FRI_URL)
                ]);

                guildData = guild;
                wednesdayData = wedData;
                fridayData = friData;

                if (statusMsg) {
                    statusMsg.className = 'status-message success';
                    statusMsg.textContent = `âœ… Data loaded successfully! Guild: ${guildData.length} members, Wed: ${wednesdayData.length} participants, Fri: ${fridayData.length} participants`;
                }

                // Calculate and display distribution
                calculateDistribution();

            } catch (error) {
                if (statusMsg) {
                    statusMsg.className = 'status-message error';
                    statusMsg.textContent = `âŒ Error loading data: ${error.message}. Please check the data source.`;
                }
                console.error('Error loading data:', error);
            } finally {
                if (loadBtn) loadBtn.disabled = false;
            }
        }

        function calculateDistribution() {
            const wedBoxes = parseInt(document.getElementById('wedRanking').value);
            const friBoxes = parseInt(document.getElementById('friRanking').value);

            console.log('Guild data rows:', guildData.length);
            console.log('Wednesday data rows:', wednesdayData.length);
            console.log('Friday data rows:', fridayData.length);
            
            if (guildData.length > 0) {
                console.log('Sample guild member:', guildData[0]);
            }
            if (wednesdayData.length > 0) {
                console.log('Sample wednesday data:', wednesdayData[0]);
            }

            // Create lookup maps for attendance data
            const wedMap = new Map();
            wednesdayData.forEach(row => {
                const name = normalizeMemberName(row['Member Name'] || row.Name);
                wedMap.set(name, parseInt(row.Points) || 0);
            });

            const friMap = new Map();
            fridayData.forEach(row => {
                const name = normalizeMemberName(row['Member Name'] || row.Name);
                friMap.set(name, parseInt(row.Points) || 0);
            });

            // Process each guild member
            distributionData = guildData.map(member => {
                const name = member['Member Name'] || member.Name;
                const attempts = parseInt(member.Attempts) || 0;
                const wedPoints = wedMap.get(name) || 0;
                const friPoints = friMap.get(name) || 0;

                return {
                    name,
                    attempts,
                    wedPoints,
                    friPoints,
                    wedBoxes: 0,
                    friBoxes: 0,
                    wedStatus: '',
                    friStatus: ''
                };
            });

            console.log('Distribution data rows:', distributionData.length);

            // Calculate Wednesday distribution
            distributeBoxes(distributionData, 'wed', wedBoxes);
            
            // Calculate Friday distribution
            distributeBoxes(distributionData, 'fri', friBoxes);

            // Calculate total boxes
            distributionData.forEach(member => {
                member.totalBoxes = member.wedBoxes + member.friBoxes;
            });

            updateTable();
            updateStats();
        }

        function distributeBoxes(data, day, totalBoxes) {
            const pointsKey = `${day}Points`;
            const boxesKey = `${day}Boxes`;
            const statusKey = `${day}Status`;

            // Separate members into categories
            const noBoxes = [];
            const oneBox = [];
            const eligible = [];

            data.forEach(member => {
                const points = member[pointsKey];
                const attempts = member.attempts;

                if (attempts === 0) {
                    member[statusKey] = 'No Attempts';
                    member[boxesKey] = 0;
                } else if (points < 200) {
                    member[statusKey] = 'No Boxes';
                    member[boxesKey] = 0;
                } else if (points === 200) {
                    member[statusKey] = 'One Box';
                    member[boxesKey] = 1;
                    oneBox.push(member);
                } else {
                    member[statusKey] = 'Eligible';
                    eligible.push(member);
                }
            });

            // Calculate boxes for eligible members
            const boxesForOneBox = oneBox.length;
            const remainingBoxes = totalBoxes - boxesForOneBox;
            const eligibleCount = eligible.length;

            if (eligibleCount > 0 && remainingBoxes > 0) {
                const boxesPerMember = Math.floor(remainingBoxes / eligibleCount);
                eligible.forEach(member => {
                    // Check if member has enough attempts
                    const availableAttempts = member.attempts;
                    member[boxesKey] = Math.min(boxesPerMember, availableAttempts);
                    
                    if (member[boxesKey] < boxesPerMember) {
                        member[statusKey] = 'Limited by Attempts';
                    }
                });
            }
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Filter data based on search
            let filteredData = distributionData.filter(member => 
                member.name.toLowerCase().includes(searchTerm)
            );

            // Sort data
            filteredData.sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                // Handle numeric sorting
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return currentSort.ascending ? aVal - bVal : bVal - aVal;
                }

                // Handle string sorting
                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();
                
                if (currentSort.ascending) {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            tbody.innerHTML = filteredData.map(member => `
                <tr>
                    <td>${member.name}</td>
                    <td>${member.attempts.toLocaleString()}</td>
                    <td>${member.wedPoints}</td>
                    <td>${member.wedBoxes}</td>
                    <td><span class="badge ${getBadgeClass(member.wedStatus)}">${member.wedStatus}</span></td>
                    <td>${member.friPoints}</td>
                    <td>${member.friBoxes}</td>
                    <td><span class="badge ${getBadgeClass(member.friStatus)}">${member.friStatus}</span></td>
                    <td><strong>${member.totalBoxes}</strong></td>
                </tr>
            `).join('');

            updateSortIndicators();
        }

        function getBadgeClass(status) {
            switch(status) {
                case 'Eligible':
                case 'Limited by Attempts':
                    return 'badge-eligible';
                case 'One Box':
                    return 'badge-one-box';
                case 'No Boxes':
                    return 'badge-no-boxes';
                case 'No Attempts':
                    return 'badge-no-attempts';
                default:
                    return '';
            }
        }

        function updateStats() {
            document.getElementById('totalMembers').textContent = guildData.length;
            document.getElementById('wedParticipants').textContent = wednesdayData.length;
            document.getElementById('friParticipants').textContent = fridayData.length;
            
            const totalWedBoxes = distributionData.reduce((sum, m) => sum + m.wedBoxes, 0);
            const totalFriBoxes = distributionData.reduce((sum, m) => sum + m.friBoxes, 0);
            
            document.getElementById('totalWedBoxes').textContent = totalWedBoxes;
            document.getElementById('totalFriBoxes').textContent = totalFriBoxes;
        }

        function updateSortIndicators() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.column === currentSort.column) {
                    th.classList.add(currentSort.ascending ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        // Event listeners
        document.getElementById('wedRanking').addEventListener('change', () => {
            if (guildData.length > 0) calculateDistribution();
        });

        document.getElementById('friRanking').addEventListener('change', () => {
            if (guildData.length > 0) calculateDistribution();
        });

        document.getElementById('searchInput').addEventListener('input', () => {
            if (distributionData.length > 0) updateTable();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                if (currentSort.column === column) {
                    currentSort.ascending = !currentSort.ascending;
                } else {
                    currentSort.column = column;
                    currentSort.ascending = false;
                }
                updateTable();
            });
        });

        // Auto-load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>
